{% extends "bootstrap/base.html" %}
<html>
<head>
<title>Executive Gender Gap</title>
 {% block styles %} {{super()}}
 <link rel="stylesheet" type="text/css" href="{{url_for('static',filename='style.css')}}"> 
 <link rel="stylesheet" type="text/css" href="{{url_for('static',filename='jumbotron-narrow.css')}}"> 
 {% endblock %}
{% block scripts %}{{super()}}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
<script type="text/javascript" charset="utf-8">
$(document).ready(function(){
    var data= getPercentage()
    var width = 1000 //max size of the bubbles
    var height =800
    color = d3.scale.category20c(); //color category

    var bubble = d3.layout.pack()
        .sort(null)
        .size([width, height])
        .padding(.5);

    var svg = d3.select("#data-container").append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("class", "bubble");
   
    // Define the div for the tooltip
    var div = d3.select("#data-container").append("div")   
        .attr("class", "tooltip")               
        .style("opacity", 0);
        
    //convert numerical values from strings to numbers
    data = data.map(function(d){ d.value =+ d["percentage"]; return d; });

    //bubbles needs very specific format, convert data to this.
    var nodes = bubble.nodes({children:data}).filter(function(d) { return !d.children; }),
        root = d3.mouse;

    root.radius = 0;
    root.fixed = true;

    //setup the chart
    var bubbles = svg.append("g")
        .attr("transform", "translate(1,0)")
        .selectAll(".bubble")
        .data(nodes)
        .enter()
        ;

    //create the bubbles
    bubbles.append("circle")
        .attr("r", function(d){ return d.r; })
        .attr("cx", function(d){ return d.x; })
        .attr("cy", function(d){ return d.y; })
        .attr('stroke','black')
        .attr('stroke-width',0)
        //mouseover hover box
        .on('mouseover', function(d){
            div.transition()        
                .duration(100)      
                .style("opacity", 1)       
            div.html(d.company + "<br>" + d.percentage + "% Female<br>Men: " + d.men + "<br>Women: " + d.women)  
                .style("left", (d3.event.pageX) + "px")     
                .style("top", (d3.event.pageY - 28) + "px");    
            d3.select(this)
              .transition()
              .duration(100)
              .attr('stroke-width',2)
        })          
        .on('mouseout', function(d){
            div.transition()        
                .duration(100)      
                .style("opacity", 0);   
            d3.select(this)
              .transition()
              .duration(1000)
              .attr('stroke-width',0)
        })
        .style("fill", function(d) { return color(d.value); })
        .text(function(d) {return d.company;});

    // format the text for each bubble
    bubbles.append("text")
            .attr("x", function(d){ return d.x; })
            .attr("y", function(d){ return d.y + 5; })

            .attr("text-anchor", "middle")
            .text(function(d){ 
                var csplit = d.company.split(" ")
                for(var i=0; i<csplit.length; i++){
                    if (csplit[0] == 'The'){
                        return csplit[1];
                    }
                    else { return csplit[0] }}
                })
            .style({
                "fill":"white", 
                "font-family":"Helvetica Neue, Helvetica, Arial, san-serif"
               
        });

    //force layout
    var force = d3.layout.force()
        .gravity(.1)
        // .friction(.001)
        // .charge(function(d, i) { return i ? 0 : -70; })
        .charge(function(d) {return -Math.pow(d.radius, 2.0) / 8;})
        .nodes(nodes)
        .size([-100, -50]);

    var bubbles = svg.selectAll("circle")
    var texts = svg.selectAll("text")
    var drag = force.drag().on("dragstart", dragstart)
    force.on("tick", function(e) {
      var q = d3.geom.quadtree(nodes),
          i = 0,
          n = nodes.length;

      while (++i < n) q.visit(collide(nodes[i]));
    
      bubbles.attr("transform", function(d) { return 'translate(' + [d.x, d.y] + ')'; });
      texts.attr("transform", function(d) { return 'translate(' + [d.x, d.y] + ')'; });
    });

    force.start();

    svg.on("mousemove", function() {
      var p1 = d3.mouse(this);
      root.px = p1[0];
      root.py = p1[1];
      force.resume();
    });

    function dragstart(d) {
        d3.select(this).classed("fixed", d.fixed = true);
    }


    // function splitBubbles(){
    //   force.on('tick', function(e) {
    //     bubbles.each(moveToPercent())
    //   }
    // }
    function collide(node) {
      var r = node.radius + 16,
          nx1 = node.x - r,
          nx2 = node.x + r,
          ny1 = node.y - r,
          ny2 = node.y + r;
      return function(quad, x1, y1, x2, y2) {
        if (quad.point && (quad.point !== node)) {
          var x = node.x - quad.point.x,
              y = node.y - quad.point.y,
              l = Math.sqrt(x * x + y * y),
              r = node.radius + quad.point.radius;
          if (l < r) {
            l = (l - r) / l * .5;
            node.x -= x *= l;
            node.y -= y *= l;
            quad.point.x += x;
            quad.point.y += y;
          }
        }
        return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;
      };
    }  
    });
    
    function getPercentage(){
        var totalCount = 0;
        var menCount =0;
        var company = '';
        var previousCompany = 'Walmart';
        var womenCount = 0;
        var unknownCount = 0;
        var companiesData = []
        var zeroCompanies = []
    
        //get male, female, and unknown count from SQL data
        '{% for row in rows %}'
            // console.log(company)
            company = '{{row.company}}'
            company = company.replace("&#39;", "'");
            company = company.replace(",", "");
            totalCount += 1;    
            '{% if "Female" in row.gender %}'
                womenCount += 1;
            '{% elif "Male" in row.gender %}'
                menCount += 1;
            '{% else %}'
                unknownCount += 1;
            '{% endif %}'

            //put data into object array
            if (company != previousCompany){
                var percentage = Math.round(womenCount/totalCount * 100)
                if (percentage!=0){
                    companiesData.push( {"company": previousCompany, "total": totalCount, "women": womenCount, "men": menCount, "unknown": unknownCount, "percentage": percentage})
                }
                else {
                    zeroCompanies.push( {"company": previousCompany, "total": totalCount, "women": womenCount, "men": menCount, "unknown": unknownCount, "percentage": percentage})
                }
                
                totalCount = 0;
                menCount = 0;
                womenCount = 0
                unknownCount = 0;
            };
            previousCompany = company
         '{% endfor %}'
        
        for (var i=0;i<zeroCompanies.length;i+=1) {
            if (zeroCompanies[i].company == 'end'){
              zeroCompanies.splice(i,1)
            }
            // console.log(zeroCompanies[i].company)
            $('#zero-container').append(zeroCompanies[i].company  + '<br>')
        }
     


        return companiesData         
 
    };
</script>

</head>{% endblock %}
{% block content %}
<body>
<div class = "container">
    <div class="header clearfix">
        <nav>
          <ul class="nav nav-pills pull-right">
            <li role="presentation" class="active"><a href="/">Home</a></li>
            <li role="presentation"><a href="/list">Database</a></li>
            <li role="presentation"><a href="/about">About</a></li>
          </ul>
        </nav>
        <h3 class="text-muted">Executive Gender Gap</h3>
      </div>

      <div class="row">
        <!-- <div class="col-lg-4"> -->
          <div id = "data-container"><br><br>
        <!-- </div> -->
      </div><br>
      </div>
      <div class ="row">
        <div id="zero-container">
          <b>Companies with less than 1% women</b><br>
        </div>

      </div>
               


      <footer class="footer">
        <p>&copy; 2017 Rina Schiller</p>
      </footer>

    </div> <!-- /container -->
</body>
{% endblock %} 
</html>